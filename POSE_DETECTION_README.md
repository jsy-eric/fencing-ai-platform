# 实时技术动作识别与解说功能说明

## 功能概述

本功能实现了基于MediaPipe姿态检测的实时技术动作识别与自动解说生成，能够在观看击剑视频时实时识别运动员的技术动作，并自动生成专业的技术解说。

## 已实现的功能

### 1. MediaPipe姿态检测集成

**文件**: `utils/pose_detector.py`

- ✅ 集成MediaPipe进行实时姿态检测
- ✅ 检测33个人体关键点
- ✅ 计算手臂角度、身体角度、手臂伸展度等特征
- ✅ 降级处理：MediaPipe不可用时使用模拟检测

**检测的关键点**:
- 头部：鼻子、眼睛、耳朵
- 上身：肩膀、手肘、手腕
- 下身：臀部、膝盖、脚踝

**提取的特征**:
- 手臂角度（左/右）
- 手臂伸展度（左/右）
- 肩膀角度（身体倾斜度）
- 身体重心位置

### 2. 基于姿态的动作识别

**文件**: `utils/action_recognizer.py`

- ✅ 基于姿态特征识别击剑动作
- ✅ 支持9种动作类型识别
- ✅ 计算动作置信度
- ✅ 结合姿态特征和上下文信息

**识别逻辑**:
- 根据手臂伸展度判断进攻/防守
- 根据手臂角度判断动作类型
- 根据身体角度判断闪避/转移
- 综合多个特征计算动作概率

### 3. 技术解说生成器

**文件**: `utils/action_commentator.py`

- ✅ 为每种动作生成专业解说
- ✅ 根据姿态特征增强解说
- ✅ 生成详细的技术分析
- ✅ 包含技术要点和常见错误

**解说特点**:
- 自然流畅的语言
- 专业的技术术语
- 根据置信度调整语气
- 结合姿态特征增强描述

### 4. 实时显示系统

**前端**: `static/js/video_monitor.js`

- ✅ 实时显示识别的动作
- ✅ 显示技术解说（带图标）
- ✅ 显示技术要点和分析
- ✅ 自动生成弹幕解说

**界面展示**:
- 动作名称和分类标签
- 置信度显示
- 技术解说（紫色渐变背景）
- 技术要点列表
- 时间戳

## 技术实现

### 后端API

**端点**: `POST /api/analyze_frame`

**增强的响应格式**:
```json
{
  "success": true,
  "analysis": {
    "action": {
      "action": "转移刺",
      "confidence": 0.85,
      "pose_features": {...}
    },
    "pose_detection": {
      "keypoints": {...},
      "features": {...}
    },
    "commentary": {
      "main_commentary": "这是一个经典的转移刺...",
      "technical_analysis": "...",
      "key_points": [...]
    }
  },
  "commentary": "这是一个经典的转移刺...",
  "detailed_commentary": {...}
}
```

### 姿态检测流程

1. **图像解码**: 将base64图像转换为numpy数组
2. **MediaPipe检测**: 使用MediaPipe检测33个关键点
3. **特征提取**: 计算角度、距离、位置等特征
4. **动作识别**: 基于特征识别动作类型
5. **解说生成**: 生成技术解说

### 动作识别算法

**基于姿态特征的动作判断**:

1. **手臂伸展度 > 0.4**: 可能是进攻动作（直刺、转移刺、进攻）
2. **手臂伸展度 < 0.2**: 可能是防守动作（格挡、闪避）
3. **手臂角度 > 120°**: 可能是格挡动作
4. **手臂角度 < 90°**: 可能是进攻动作
5. **身体倾斜 > 15°**: 可能是闪避或转移动作

## 安装依赖

```bash
pip install mediapipe opencv-python numpy Pillow
```

或使用requirements.txt:
```bash
pip install -r requirements.txt
```

## 使用方法

### 用户操作

1. **加载视频**: 输入YouTube链接并加载视频
2. **自动识别**: 系统每5秒自动检测姿态并识别动作
3. **查看解说**: 在右侧"动作分析"面板查看实时识别结果和技术解说

### 开发者配置

#### 使用MediaPipe（推荐）

MediaPipe会自动安装，如果安装失败，系统会使用降级方案。

#### 调整检测参数

在 `utils/pose_detector.py` 中:
```python
self.pose = self.mp_pose.Pose(
    static_image_mode=False,
    model_complexity=1,  # 0-2，数字越大精度越高但速度越慢
    min_detection_confidence=0.5,
    min_tracking_confidence=0.5
)
```

## 技术解说示例

### 转移刺
> "这是一个经典的转移刺，运动员利用假动作迷惑对手，然后快速转移攻击方向。"

### 直刺
> "看这个直刺！运动员保持了良好的身体平衡，手臂完全伸展，时机把握精准。"

### 格挡
> "这是一个及时的格挡，运动员反应迅速，成功化解了对手的进攻。"

## 界面展示

### 技术解说样式

- **背景**: 紫色渐变（#667eea 到 #764ba2）
- **图标**: 🎙️ 麦克风图标
- **文字**: 白色，加粗，易读
- **位置**: 动作分析面板顶部，突出显示

### 动画效果

- 识别结果更新时有淡入动画
- 解说区域有阴影效果
- 左侧有白色边框装饰

## 性能优化

### 检测速度

- MediaPipe在CPU上运行，每帧约30-50ms
- 每5秒检测一次，不影响视频播放
- 检测结果缓存，避免重复计算

### 降级方案

如果MediaPipe不可用：
- 使用模拟姿态检测
- 基于时间和上下文识别动作
- 仍然生成技术解说

## 未来改进

1. **GPU加速**: 使用GPU加速MediaPipe检测
2. **多帧分析**: 结合多帧数据提高识别准确度
3. **动作序列识别**: 识别连续动作组合
4. **个性化解说**: 根据用户水平调整解说详细程度
5. **语音合成**: 将文字解说转换为语音

## 测试

### 测试步骤

1. 安装依赖: `pip install mediapipe opencv-python numpy Pillow`
2. 启动应用
3. 加载击剑视频
4. 观察动作分析面板
5. 每5秒应该看到新的识别结果和技术解说

### 预期结果

- ✅ 每5秒自动检测姿态
- ✅ 识别动作类型
- ✅ 生成技术解说
- ✅ 显示在界面上
- ✅ 同时生成弹幕解说

## 注意事项

1. **MediaPipe安装**: 需要Python 3.8+，某些系统可能需要额外配置
2. **性能**: MediaPipe在CPU上运行，可能影响性能，建议使用GPU加速
3. **跨域限制**: YouTube iframe的跨域限制可能影响图像获取
4. **图像质量**: 图像质量影响检测精度，建议使用高清视频

